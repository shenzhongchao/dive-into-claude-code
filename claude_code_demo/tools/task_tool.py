"""
Task/SubAgent å·¥å…·
å®ç° Claude Code çš„å¤š Agent åä½œæœºåˆ¶
"""
from typing import Literal
from langchain_core.tools import tool
from langchain_core.messages import HumanMessage
from langgraph.prebuilt import create_react_agent

from config import SubAgentConfig


TASK_TOOL_DESCRIPTION = """Launch specialized SubAgents to autonomously handle complex multi-step tasks.

Available Agent types:
- **general-purpose**: General agent suitable for complex queries, file searches, and multi-step task execution (Tools: *)
- **code-analyzer**: Code analysis expert for code review, architecture analysis, performance optimization (Tools: Read, Grep, Glob)
- **document-writer**: Documentation expert for technical docs, user manuals, API documentation (Tools: Read, Write, Edit)

Usage rules:
1. Use this tool when tasks are complex and require specialized handling
2. Each SubAgent invocation is independent and stateless
3. Provide detailed task descriptions; SubAgents will complete autonomously
4. After SubAgent completion, summarize key information for the user

When to use SubAgents:
- Complex multi-step analysis tasks
- Tasks requiring specialized skills (code analysis, documentation)
- Large-scale file search and processing
- Independent tasks that can be processed in parallel

Note: SubAgents have isolated context and cannot access the main agent's conversation history.
"""


class TaskToolManager:
    """Task å·¥å…·ç®¡ç†å™¨"""

    def __init__(self, llm, base_tools: list, subagent_configs: list[SubAgentConfig]):
        """
        åˆå§‹åŒ– Task å·¥å…·ç®¡ç†å™¨

        Args:
            llm: è¯­è¨€æ¨¡å‹
            base_tools: åŸºç¡€å·¥å…·åˆ—è¡¨
            subagent_configs: SubAgent é…ç½®åˆ—è¡¨
        """
        self.llm = llm
        self.base_tools = base_tools
        self.subagent_configs = subagent_configs

        # åˆ›å»º SubAgent å®ä¾‹
        self.subagents = {}
        for config in subagent_configs:
            self.subagents[config.type] = self._create_subagent(config)

    def _create_subagent(self, config: SubAgentConfig):
        """åˆ›å»º SubAgent å®ä¾‹"""
        # è¿‡æ»¤å·¥å…·
        if config.allowed_tools is None:
            # å…è®¸æ‰€æœ‰å·¥å…·ï¼Œä½†æ’é™¤ TaskToolï¼ˆé˜²æ­¢é€’å½’ï¼‰
            tools = [t for t in self.base_tools if t.name != "task_tool"]
        else:
            # åªå…è®¸æŒ‡å®šçš„å·¥å…·
            tools = [
                t for t in self.base_tools
                if t.name in config.allowed_tools
            ]

        # åˆ›å»º ReAct Agent
        agent = create_react_agent(
            self.llm,
            tools=tools,
            prompt=config.system_prompt
        )

        return agent

    def execute_task(
        self,
        description: str,
        subagent_type: Literal["general-purpose", "code-analyzer", "document-writer"]
    ) -> str:
        """
        æ‰§è¡Œ SubAgent ä»»åŠ¡

        Args:
            description: ä»»åŠ¡æè¿°
            subagent_type: SubAgent ç±»å‹

        Returns:
            SubAgent æ‰§è¡Œç»“æœ
        """
        # è·å–å¯¹åº”çš„ SubAgent
        agent = self.subagents.get(subagent_type)
        if not agent:
            return f"Error: Unknown SubAgent type: {subagent_type}"

        try:
            print(f"ğŸ¤– Launching SubAgent [{subagent_type}]: {description}")

            # åˆ›å»ºéš”ç¦»çš„æ‰§è¡Œä¸Šä¸‹æ–‡
            result = agent.invoke({
                "messages": [HumanMessage(content=description)]
            })

            # æå–æœ€ç»ˆå“åº”
            final_message = result["messages"][-1]
            response_content = final_message.content

            print(f"âœ… SubAgent [{subagent_type}] completed")

            # è¿”å›æ ¼å¼åŒ–ç»“æœ
            return f"""SubAgent [{subagent_type}] execution completed:

Task: {description}

Result:
{response_content}

Note: This result was generated by a specialized SubAgent. Please summarize key information for the user as needed."""

        except Exception as e:
            print(f"âŒ SubAgent [{subagent_type}] failed: {e}")
            return f"SubAgent [{subagent_type}] execution failed: {str(e)}"


def create_task_tool(llm, base_tools: list, subagent_configs: list[SubAgentConfig]):
    """
    åˆ›å»º Task å·¥å…·

    Args:
        llm: è¯­è¨€æ¨¡å‹
        base_tools: åŸºç¡€å·¥å…·åˆ—è¡¨
        subagent_configs: SubAgent é…ç½®åˆ—è¡¨

    Returns:
        Task å·¥å…·
    """
    manager = TaskToolManager(llm, base_tools, subagent_configs)

    @tool(description=TASK_TOOL_DESCRIPTION)
    def task_tool(
        description: str,
        subagent_type: Literal["general-purpose", "code-analyzer", "document-writer"]
    ) -> str:
        """
        å¯åŠ¨ä¸“ç”¨ SubAgent å¤„ç†å¤æ‚ä»»åŠ¡

        Args:
            description: è¯¦ç»†çš„ä»»åŠ¡æè¿°
            subagent_type: è¦ä½¿ç”¨çš„ SubAgent ç±»å‹

        Returns:
            SubAgent æ‰§è¡Œç»“æœ
        """
        return manager.execute_task(description, subagent_type)

    return task_tool
